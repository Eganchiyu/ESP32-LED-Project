#include <Arduino.h>
#include "config.h"
#include "LED_Controller.h"

void setup() {
  Serial.begin(115200);
  
  pinMode(BOARD_LED_PIN, OUTPUT);
  pinMode(MOTION_SENSOR_PIN, INPUT);
  
  Serial.println("====================================");
  Serial.println("åŒç¯ç¯ç³»ç»Ÿå¯åŠ¨ - WiFiæ§åˆ¶ç‰ˆ");
  Serial.println("====================================");
  
  // åˆå§‹åŒ–LED
  setupLEDs();
  
  // è¿æ¥WiFi
  Serial.println("æ­£åœ¨è¿æ¥WiFi...");
  Serial.print("SSID: ");
  Serial.println(ssid);
  
  if (!WiFi.config(local_IP, gateway, subnet)) {
    Serial.println("STA Failed to configure");
  }
  
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
    digitalWrite(BOARD_LED_PIN, !digitalRead(BOARD_LED_PIN));
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFiè¿æ¥æˆåŠŸ!");
    Serial.print("IPåœ°å€: ");
    Serial.println(WiFi.localIP());
    digitalWrite(BOARD_LED_PIN, HIGH);
    quickTestLeds();
  } else {
    Serial.println("\nWiFiè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼");
    digitalWrite(BOARD_LED_PIN, LOW);
    quickTestLeds();
  }
  
  // è®¾ç½®WebæœåŠ¡å™¨
  server.on("/", handleRoot);
  server.on("/control", handleControl);
  server.onNotFound(handleNotFound);
  server.begin();
  Serial.println("HTTPæœåŠ¡å™¨å·²å¯åŠ¨");
  Serial.println("è¯·ç”¨æµè§ˆå™¨è®¿é—®: http://" + WiFi.localIP().toString());
}

void loop() {
  // å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
  server.handleClient();
  
  // ä¼ æ„Ÿå™¨æ£€æµ‹ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰
  if (currentState != STATE_MANUAL && currentState != STATE_OFF) {
    currentMotionState = digitalRead(MOTION_SENSOR_PIN);
    
    if (currentMotionState != lastMotionState) {
      lastMotionState = currentMotionState;
      lastMotionTime = millis();
      
      if (currentMotionState) {
        Serial.println("ğŸš¶ æ£€æµ‹åˆ°äººä½“ç§»åŠ¨ï¼");
        digitalWrite(BOARD_LED_PIN, HIGH);
        
        if (currentState == STATE_OFF || currentState == STATE_FADE_OUT) {
          currentState = STATE_BREATHE;
          breatheStep = 0;
          startHue = 0;
          ringHue = 0;
        }
      } else {
        Serial.println("ğŸ’¤ æ— äººä½“ç§»åŠ¨");
        digitalWrite(BOARD_LED_PIN, LOW);
        
        if (currentState == STATE_NORMAL) {
          currentState = STATE_FADE_OUT;
        }
      }
    }
  }
  
  // æ›´æ–°LEDçŠ¶æ€
  updateLEDs();
  
  // çŠ¶æ€è¾“å‡º
  if (currentMotionState && currentState != STATE_MANUAL) {
    unsigned long currentTime = millis();
    if (currentTime - lastMotionTime > 5000) {
      Serial.println("ğŸ“ äººä½“ä»åœ¨æ£€æµ‹èŒƒå›´å†…");
      lastMotionTime = currentTime;
    }
  }
}
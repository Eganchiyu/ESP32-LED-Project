#include <WiFi.h>
#include <FastLED.h>

#define LED_PIN 15
#define TOTAL_LEDS 35
#define START_LED 4
#define NUM_LEDS 30

CRGB leds[TOTAL_LEDS];
WiFiServer server(8080);

void setup() {
  FastLED.addLeds<WS2812, LED_PIN, GRB>(leds, TOTAL_LEDS);
  FastLED.setBrightness(50); // 稍微提高亮度，因为处理更快了
  
  // 设置固定IP地址
  IPAddress local_IP(192, 168, 31, 114);
  IPAddress gateway(192, 168, 31, 1);
  IPAddress subnet(255, 255, 255, 0);
  
  WiFi.config(local_IP, gateway, subnet);
  WiFi.begin("基沃托斯", "1111111q");
  
  while (WiFi.status() != WL_CONNECTED) delay(500);
  
  server.begin();
  
  // 快速测试LED
  for(int i = START_LED; i < START_LED + NUM_LEDS; i++) {
    leds[i] = CRGB::White;
  }
  FastLED.show();
  delay(100);
  for(int i = START_LED; i < START_LED + NUM_LEDS; i++) {
    leds[i] = CRGB::Black;
  }
  FastLED.show();
}

void loop() {
  WiFiClient client = server.available();
  if (client) {
    while (client.connected()) {
      if (client.available()) {
        String data = client.readStringUntil('\n');
        data.trim();
        
        // 快速解析数据
        int values[90];
        int index = 0;
        int lastIndex = 0;
        
        for (int i = 0; i < data.length(); i++) {
          if (data.charAt(i) == ',') {
            values[index++] = data.substring(lastIndex, i).toInt();
            lastIndex = i + 1;
          }
        }
        values[index] = data.substring(lastIndex).toInt();
        
        // 快速设置LED
        for (int i = 0; i < NUM_LEDS; i++) {
          int r = values[i * 3];
          int g = values[i * 3 + 1];
          int b = values[i * 3 + 2];
          leds[START_LED + i] = CRGB(r, g, b);
        }
        FastLED.show();
      }
      delay(1); // 最小延迟
    }
    client.stop();
  }
}